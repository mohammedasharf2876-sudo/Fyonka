<!-- index.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ÙÙŠÙˆÙ†ÙƒØ© - Fyonka Gallery</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background-color: #fff5f7;
      margin: 0; padding: 0;
      overscroll-behavior: none;
    }
    .mobile-container {
      max-width: 450px;
      margin: 0 auto;
      background: white;
      height: 100vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 20px rgba(0,0,0,0.05);
      position: relative;
    }
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background-image: url('https://www.transparenttextures.com/patterns/pink-dust.png');
    }
    .bubble {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 20px;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.02);
      word-break: break-word;
    }
    .bot {
      background: #ffffff;
      color: #444;
      align-self: flex-start;
      border-bottom-right-radius: 6px;
      border: 1px solid #fce4ec;
    }
    .user {
      background: #ff5c8d;
      color: white;
      align-self: flex-end;
      border-bottom-left-radius: 6px;
    }
    .input-box {
      background: white;
      padding: 15px;
      border-top: 1px solid #ffebee;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    input {
      flex: 1;
      background: #f8f9fa;
      border: 1px solid #eee;
      padding: 12px 20px;
      border-radius: 30px;
      outline: none;
      font-size: 14px;
    }
    .send-btn {
      background: #ff5c8d;
      color: white;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(255, 92, 141, 0.30);
    }
    .send-btn:disabled{
      opacity: .55;
      cursor: not-allowed;
      box-shadow: none;
    }
    .typing { display: flex; gap: 4px; padding: 10px; }
    .dot { width: 6px; height: 6px; background: #ff85a2; border-radius: 50%; animation: blink 1.4s infinite; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
  </style>
</head>

<body>
  <div class="mobile-container">
    <header class="bg-[#ff5c8d] p-4 text-white flex items-center gap-3 shadow-lg">
      <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-xl">ğŸ€</div>
      <div>
        <h1 class="font-bold text-base">ÙÙŠÙˆÙ†ÙƒØ© - Fyonka</h1>
        <p class="text-[10px] opacity-80">Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù† â€¢ Ø®Ø¨ÙŠØ±Ø© Ø§Ù„Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª</p>
      </div>
    </header>

    <div id="chatBox" class="chat-area flex flex-col"></div>

    <div id="loading" class="hidden px-4 pb-2">
      <div class="typing">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
      </div>
    </div>

    <div class="input-box">
      <input type="text" id="userInput" placeholder="Ø§Ø³Ø£Ù„ÙŠ ÙÙŠÙˆÙ†ÙƒØ© Ø¹Ù† Ù‚Ø·Ø¹Ø©..." />
      <button id="sendBtn" class="send-btn" onclick="sendMessage()">
        <svg style="transform: rotate(180deg)" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M5 12h14M12 5l7 7-7 7"/>
        </svg>
      </button>
    </div>
  </div>

  <script>
    const FyonkaDB = {
      "Ø®Ø§ØªÙ…": "ğŸ’ Ø§Ù„Ø®Ø§ØªÙ… ÙŠØ¬Ù†Ù† Ø¹Ù„ÙŠÙƒÙŠ! Ø¨Ø³ Ù†ØµÙŠØ­Ø© ÙÙŠÙˆÙ†ÙƒØ©: Ø§Ø¨Ø¹Ø¯ÙŠ Ø¹Ù†Ù‡ Ø§Ù„ØµØ§Ø¨ÙˆÙ† ÙˆØ§Ù„Ù…ÙŠØ© Ø¹Ø´Ø§Ù† ÙØµÙˆØµÙ‡ ØªÙØ¶Ù„ ØªÙ„Ù…Ø¹ØŒ ÙˆÙ„Ùˆ Ø¯Ø®Ù„ØªÙŠ Ø§Ù„Ø­Ù…Ø§Ù… Ø§Ù‚Ù„Ø¹ÙŠÙ‡ Ø£Ø­Ø³Ù† Ø¹Ø´Ø§Ù† Ù…ÙŠØªØ²Ø­Ù„Ù‚Ø´ Ù…Ù† Ø§Ù„ØµØ§Ø¨ÙˆÙ† ÙˆÙŠØ¶ÙŠØ¹.",
      "Ø³Ù„Ø³Ù„Ø©": "ğŸ“¿ Ø§Ù„Ø³Ù„Ø§Ø³Ù„ Ø§Ù„Ø±Ù‚ÙŠÙ‚Ø© Ø¯ÙŠ Ø¨ØªØ­Ø¨ Ø§Ù„Ø¯Ù„Ø¹ØŒ Ø¨Ù„Ø§Ø´ ØªÙ†Ø§Ù…ÙŠ Ø¨ÙŠÙ‡Ø§ Ø¹Ø´Ø§Ù† Ù…ØªØªØ¹Ù‚Ø¯Ø´ØŒ ÙˆÙ„Ùˆ Ø±Ø´Ø© Ø¨Ø±ÙØ§Ù† Ø§Ø³ØªÙ†ÙŠ Ù„Ù…Ø§ ØªÙ†Ø´Ù ÙˆØ¨Ø¹Ø¯ÙŠÙ† Ø§Ù„Ø¨Ø³ÙŠÙ‡Ø§.",
      "Ø³Ø§Ø¹Ø©": "âŒš Ø³Ø§Ø¹ØªÙƒ Ø´ÙŠØ§ÙƒØªÙƒ! Ø­ØªÙ‰ Ù„Ùˆ Ø¶Ø¯ Ø§Ù„Ù…ÙŠØ© Ø¨Ù„Ø§Ø´ ØªØ¹Ø±Ø¶ÙŠÙ‡Ø§ Ù„Ù„ØµØ§Ø¨ÙˆÙ† ÙˆØ§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ÙƒÙŠÙ…Ø§ÙˆÙŠØ© Ø¹Ø´Ø§Ù† Ø§Ù„Ø¬Ù„Ø¯ Ø£Ùˆ Ø§Ù„Ù…Ø¹Ø¯Ù† Ù…ØºÙŠØ±Ø´ Ù„ÙˆÙ†.",
      "ØºÙˆØ§ÙŠØ´": "ğŸ’« Ø§Ù„ØºÙˆØ§ÙŠØ´ Ø¯ÙŠ Ù…Ø­ØªØ§Ø¬Ø© Ø­Ø±ØµØŒ Ø§Ø¨Ø¹Ø¯ÙŠÙ‡Ø§ Ø¹Ù† Ø§Ù„Ø®Ø¨Ø·Ø§Øª Ø§Ù„Ø¬Ø§Ù…Ø¯Ø© ÙˆÙ„Ù…Ø¹ÙŠÙ‡Ø§ Ø¨Ù‚Ø·Ù†Ø© Ù†Ø§Ø´ÙØ© Ù‡ØªØ±Ø¬Ø¹ ØªØ¨Ø±Ù‚.",
      "Ø¹Ø§Ù…Ø©": "Ù†ÙˆØ±ØªÙŠ ÙÙŠÙˆÙ†ÙƒØ© ÙŠØ§ Ù‚Ù…Ø±! ğŸ€ Ø£ÙŠ Ù‚Ø·Ø¹Ø© Ø¹Ù†Ø¯Ù†Ø§ Ø¨ØªØ­ØªØ§Ø¬ Ø¹Ù†Ø§ÙŠØ© Ø¨Ø³ÙŠØ·Ø©: Ø§Ø¨Ø¹Ø¯ÙŠ Ø¹Ù†Ù‡Ø§ Ø§Ù„Ù…ÙŠØ© ÙˆØ§Ù„ÙƒØ­ÙˆÙ„ ÙˆØ§Ù„Ø¨Ø±ÙØ§Ù† Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù‡ØªØ¹ÙŠØ´ Ù…Ø¹Ø§ÙƒÙŠ Ø§Ù„Ø¹Ù…Ø± ÙƒÙ„Ù‡."
    };

    const allowedTypes = ["Ø®Ø§ØªÙ…","Ø³Ù„Ø³Ù„Ø©","Ø³Ø§Ø¹Ø©","ØºÙˆØ§ÙŠØ´","Ø¹Ø§Ù…Ø©"];
    const params = new URLSearchParams(window.location.search);
    const rawType = (params.get('type') || "Ø¹Ø§Ù…Ø©").trim();
    const pType = allowedTypes.includes(rawType) ? rawType : "Ø¹Ø§Ù…Ø©";

    const history = [];
    let busy = false;

    function escapeHTML(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function formatBotText(text) {
      let safe = escapeHTML(text);
      safe = safe.replace(/\*\*(.+?)\*\*/g, "<b>$1</b>");
      safe = safe.replace(/\n/g, "<br>");
      return safe;
    }

    function addMsg(text, side, allowHTML = false) {
      const box = document.getElementById('chatBox');
      const div = document.createElement('div');
      div.className = `bubble ${side}`;

      if (allowHTML) div.innerHTML = text;
      else div.textContent = text;

      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    setTimeout(() => {
      let msg = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒÙŠ ÙÙŠ ÙÙŠÙˆÙ†ÙƒØ©! ğŸ€ Ø°ÙˆÙ‚Ùƒ ÙÙŠ Ø§Ù„Ù€ <b>${pType}</b> ÙŠØ¬Ù†Ù†.`;
      if (FyonkaDB[pType]) msg += `<br><br>${escapeHTML(FyonkaDB[pType]).replace(/\n/g,"<br>")}`;
      addMsg(msg, 'bot', true);
    }, 300);

    document.getElementById('userInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    async function sendMessage() {
      if (busy) return;

      const input = document.getElementById('userInput');
      const text = input.value.trim();
      if (!text) return;

      addMsg(text, 'user', false);
      input.value = '';
      document.getElementById('loading').classList.remove('hidden');

      busy = true;
      document.getElementById('sendBtn').disabled = true;

      try {
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            type: pType,
            message: text,
            history: history.slice(-12)
          })
        });

        if (!res.ok) throw new Error("API error");

        const data = await res.json();
        const reply = (data && data.reply) ? String(data.reply) : "Ù…Ø¹Ù„Ø´ ÙŠØ§ Ù‚Ù…Ø±â€¦ Ù‚ÙˆÙ„ÙŠ ØªØ§Ù†ÙŠ ğŸ€";

        history.push({ role: "user", parts: [{ text }] });
        history.push({ role: "model", parts: [{ text: reply }] });

        document.getElementById('loading').classList.add('hidden');
        addMsg(formatBotText(reply), 'bot', true);
      } catch (e) {
        document.getElementById('loading').classList.add('hidden');
        addMsg("Ù…Ø¹Ù„Ø´ ÙŠØ§ Ù‚Ù…Ø± Ø­ØµÙ„ Ù…Ø´ÙƒÙ„Ø©â€¦ Ø¬Ø±Ù‘Ø¨ÙŠ ØªØ§Ù†ÙŠ ğŸ€", 'bot', false);
      } finally {
        busy = false;
        document.getElementById('sendBtn').disabled = false;
      }
    }
  </script>
</body>
</html>
