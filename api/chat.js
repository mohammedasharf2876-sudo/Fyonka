// api/chat.js  (NO KEY NEEDED โ) โ ูููููุฉ: ุฅูุณุณูุงุฑุงุช + ูููุงุจ + ุณููู ููุฑ (ูุตุฑู ุจูุงุชู)
function send(res, status, obj) {
  res.statusCode = status;
  res.setHeader("Content-Type", "application/json; charset=utf-8");
  res.setHeader("Cache-Control", "no-store");
  res.end(JSON.stringify(obj));
}

async function readBodyJSON(req) {
  if (req.body && typeof req.body === "object") return req.body;
  let raw = "";
  for await (const chunk of req) raw += chunk;
  if (!raw) return {};
  try { return JSON.parse(raw); } catch { return {}; }
}

// ===== โุจุฑููุจุช ุฎูููโ ุนูู ุดูู ููุงุนุฏ ุฑุฏ =====
function wrapReply({ opener, title, bullets = [], steps = [], note, ask }) {
  const out = [];
  if (opener) out.push(opener);
  if (title) out.push(`**${title}**`);
  if (bullets.length) {
    out.push("");
    bullets.forEach(b => out.push(`โ ${b}`));
  }
  if (steps.length) {
    out.push("");
    out.push("**ุฎุทูุงุช ุณุฑูุนุฉ:**");
    steps.forEach((s, i) => out.push(`${i + 1}) ${s}`));
  }
  if (note) {
    out.push("");
    out.push(`โ๏ธ ${note}`);
  }
  if (ask) {
    out.push("");
    out.push(`ุณุคุงู ุตุบูุฑ ูุง ููุฑ: ${ask}`);
  }
  return out.join("\n");
}

function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
function hasAny(msg, arr) { return arr.some(k => msg.includes(k)); }

function detectDomain(message) {
  const m = message;
  const skincareKeys = ["ุณููู", "ุจุดุฑุฉ", "ุฑูุชูู", "ุบุณูู", "ูุฑุทุจ", "ูุงูู", "spf", "ุณูุฑู", "ููุชุงููู", "ููุงุณููุงููุฏ", "ููุงููุฑูููู", "ุฑูุชูููู", "ุชูุดูุฑ", "aha", "bha", "ุณุงููุณูููู", "ุฌููููููู", "ุญุณุงุณูุฉ", "ุญูุฉ", "ุชููุฌ"];
  const makeupKeys = ["ูููุงุจ", "makeup", "ูุงููุฏูุดู", "ูููุณููุฑ", "ุจูุฏุฑุฉ", "ุจุฑุงููุฑ", "ุจูุงุดุฑ", "ุจุฑููุฒุฑ", "ูุงููุงูุชุฑ", "ุขูุดุงุฏู", "ุงูุดุงุฏู", "ุขููุงููุฑ", "ุงููุงููุฑ", "ูุงุณูุงุฑุง", "ุฑูุฌ", "ููุจ", "lip", "ุญูุงุฌุจ", "setting", "ุณุชูุฌ", "ุณุจุฑุงู"];
  const accKeys = ["ุฎุงุชู", "ุณูุณูุฉ", "ุงูุณูุงู", "ุบูุงูุด", "ุญูู", "ุชููุฉ", "ุฏุจูุณ", "ููููู", "ุฎูุฎุงู", "ุงูุณุณูุงุฑ", "ุฅูุณุณูุงุฑ", "ุณุชุงููุณ", "ูุถุฉ", "ูุทูู"];

  if (hasAny(m, skincareKeys)) return "skincare";
  if (hasAny(m, makeupKeys)) return "makeup";
  if (hasAny(m, accKeys)) return "accessories";
  return "general";
}

function detectAccessoryType(message, hint = "ุนุงูุฉ") {
  const m = message;
  if (m.includes("ุฎุงุชู")) return "ุฎุงุชู";
  if (m.includes("ุณูุณูุฉ") || m.includes("ุณูุณูู") || m.includes("ููููู") || m.includes("ููููู")) return "ุณูุณูุฉ";
  if (m.includes("ุงูุณูุงู") || m.includes("ุฅุณูุฑุฉ") || m.includes("ุงุณูุฑุฉ") || m.includes("ุณูุงุฑ")) return "ุงูุณูุงู";
  if (m.includes("ุบูุงูุด") || m.includes("ุบููุดุฉ") || m.includes("ุบููุดู")) return "ุบูุงูุด";
  if (m.includes("ุญูู") || m.includes("ูุฑุท")) return "ุญูู";
  if (m.includes("ุฎูุฎุงู")) return "ุฎูุฎุงู";
  if (m.includes("ุชููุฉ") || m.includes("ุฏุจูุณ")) return "ุชูู/ุฏุจุงุจูุณ";
  return hint || "ุนุงูุฉ";
}

function detectMaterial(message) {
  const m = message;
  if (hasAny(m, ["ุณุชุงููุณ", "stainless"])) return "ุณุชุงููุณ";
  if (hasAny(m, ["ูุถุฉ", "ูุถู", "silver"])) return "ูุถุฉ";
  if (hasAny(m, ["ูุทูู", "ูุทููุฉ", "plated"])) return "ูุทูู";
  if (hasAny(m, ["ุฐูุจ", "ุฏูุจ", "gold"])) return "ุฐูุจ";
  if (hasAny(m, ["ูุญุงุณ"])) return "ูุญุงุณ";
  return "";
}

function detectSkinType(message) {
  const m = message;
  if (hasAny(m, ["ุฏูููุฉ", "ุฏูููู", "ุฒูุชูุฉ", "ุฒูุชูุฉ"])) return "ุฏูููุฉ";
  if (hasAny(m, ["ุฌุงูุฉ", "ุฌุงูู", "ูุงุดูุฉ", "ูุงุดูู"])) return "ุฌุงูุฉ";
  if (hasAny(m, ["ูุฎุชูุทุฉ", "ูุฎูุทุฉ", "ูููุณ"])) return "ูุฎุชูุทุฉ";
  if (hasAny(m, ["ุญุณุงุณุฉ", "ุญุณุงุณู"])) return "ุญุณุงุณุฉ";
  if (hasAny(m, ["ุนุงุฏูุฉ", "ุนุงุฏูู"])) return "ุนุงุฏูุฉ";
  return "";
}

function detectConcern(message) {
  const m = message;
  if (hasAny(m, ["ุญุจูุจ", "ุญุจุงูุฉ", "acne"])) return "ุญุจูุจ";
  if (hasAny(m, ["ุชุตุจุบุงุช", "ุจูุน", "ุงุณูุฑุงุฑ", "ููู", "melasma"])) return "ุชุตุจุบุงุช";
  if (hasAny(m, ["ูุณุงู", "pore"])) return "ูุณุงู";
  if (hasAny(m, ["ุฌูุงู", "ุดุฏ", "ุชูุดูุฑ"])) return "ุฌูุงู";
  if (hasAny(m, ["ุญุณุงุณูุฉ", "ุชููุฌ", "ุงุญูุฑุงุฑ", "ุญูุฉ"])) return "ุญุณุงุณูุฉ";
  if (hasAny(m, ["ุจูุชุงู", "ูุฌูุฏุฉ", "ุงุดุฑุงู", "glow"])) return "ุจูุชุงู";
  return "";
}

// ===== ููุงุนุฏ ุฑุฏูุฏ ุฌุงูุฒุฉ =====
const ACCESSORY_TIPS = {
  "ุฎุงุชู": [
    "ุงุจุนุฏูู ุนู ุงูููุฉ ูุงูุตุงุจูู ูุงููุญูู ุนุดุงู ุงูููู ูุงููุตูุต ููุถููุง ุญูููู.",
    "ุดูููู ููุช ุงูุญููุงู/ุบุณูู ุงูููุงุนููโฆ ุนุดุงู ูุงูุฒุญููุด ููุชูู.",
    "ุฎุฒููู ููุญุฏู ูู ููุณ ููุงุด/ุนูุจุฉ ุนุดุงู ููุฎุฑุจุด ูุน ุงููุทุน ุงูุชุงููุฉ."
  ],
  "ุณูุณูุฉ": [
    "ุจูุงุด ููู ุจููุง ุนุดุงู ูุชุชุนูุฏุด.",
    "ุงูุจุฑูุงู/ุงูุณุจุฑุงู ูุงุฒู ููุดู ุงูุฃูู ูุจุนุฏูู ุชูุจุณููุง.",
    "ูู ุงุชุนูุฏุช: ุงูุฑุฏููุง ุนูู ุณุทุญ ูุงุนู ูุญุฑููู ุงูุนูุฏุฉ ุจูุฏูุก ุจุฏุจูุณ."
  ],
  "ุงูุณูุงู": [
    "ุดูููู ููุช ุงูุดุงูุฑ ูุงูุจุญุฑ ูุงููููุฑ.",
    "ุจูุงุด ุดุฏ ุฌุงูุฏ ุนูู ุงูุณูุณูุฉ ุงูุฑูููุฉ ุนุดุงู ูุชุชููุด.",
    "ุงูุณุญูู ุจุนุฏ ุงููุจุณ ุจูุทูุฉ ูุงุดูุฉ."
  ],
  "ุบูุงูุด": [
    "ุงุจุนุฏููุง ุนู ุงูุฎุจุทุงุช ุงูุฌุงูุฏุฉ ุนุดุงู ูุชุชุฌุฑุญุด.",
    "ูููุนู ุจูุทูุฉ ูุงุดูุฉ ุฃู ููุงุดุฉ ูููุฑููุงูุจุฑ.",
    "ูุชุชุฎุฒููุด ููู ูุจูููุฉโฆ ุงูุฑุทูุจุฉ ุจุชุจููุธ ุงูููู."
  ],
  "ุญูู": [
    "ูู ูุฏูู ุจุชุชุญุณุณ: ุงุฎุชุงุฑู ุณุชุงููุณ/ูุถุฉ ูุงูุชูู ุจุชูุถูู ุงูููุงู ูุจู ุงููุจุณ.",
    "ูุชูุงููุด ุจูู ูู ุทููู/ูุฏููู ุนุดุงู ููุถุบุทุด ุนูู ุงููุฏู.",
    "ุจูุงุด ุนุทุฑ ูุจุงุดุฑ ุนูู ุงูุญูู."
  ],
  "ุฎูุฎุงู": [
    "ุงุชุฌูุจู ุงูููุฉ ูุงููููุฑ ุนุดุงู ุงูุฑุฌู ุจุชุชุนุฑุถ ููุฑุทูุจุฉ ุฃูุชุฑ.",
    "ุฎุฒููู ููุญุฏู ุนุดุงู ููุนููุด ุฎุฏูุด.",
    "ุงูุณุญูู ูุงุดู ุจุนุฏ ูู ูุจุณ."
  ],
  "ุชูู/ุฏุจุงุจูุณ": [
    "ุฎูููู ุจุนูุฏ ุนู ุงูููุฉ ุนุดุงู ุงููุนุฏู ููุณููุณุด.",
    "ูู ูููู ููุงุด/ุณุชุฑุงุณุงุช: ุชูุถูู ุฎููู ุจูุฑุดุฉ ูุงุนูุฉ ูุงุดูุฉ.",
    "ุฎุฒูููู ูู ุนูุจุฉ ููุณููุฉ ุนุดุงู ููุชูุณุฑุด ุงูุดูู."
  ],
  "ุนุงูุฉ": [
    "ูุงุนุฏุฉ ูููููุฉ: ููุฉ + ุนุทุฑ + ูุญูู = ุนูุฑ ุงููุทุนุฉ ููุตุฑโฆ ูุฎูููู ุจุนูุฏ ๐",
    "ุฎุฒููู ูู ูุทุนุฉ ููุญุฏูุงุ ูุงูุณุญููุง ูุงุดู ุจุนุฏ ุงููุจุณ.",
    "ูู ุงูููู ุจูุบูู ุจุณุฑุนุฉ: ุบุงูุจูุง ูู ุนุฑู/ุนุทุฑโฆ ุฎููู ุจุนูุฏ."
  ]
};

function accessoryReply(message, hintType) {
  const type = detectAccessoryType(message, hintType);
  const mat = detectMaterial(message);
  const extra = [];

  if (mat === "ูุทูู") extra.push("ูู ูุทูู: ุจูุงุด ููุฉ ุฎุงูุต + ุจูุงุด ุนุทุฑ ูุจุงุดุฑ ุนุดุงู ุงูููู ููุจูุชุด.");
  if (mat === "ูุถุฉ") extra.push("ูู ูุถุฉ: ุงุณูุฏุงุฏ ุจุณูุท ุทุจูุนูโฆ ูุชูููุน ุจููุงุดุฉ ูุถุฉ (ูุด ููุฉ).");
  if (mat === "ุณุชุงููุณ") extra.push("ุงูุณุชุงููุณ ุนููู ุฌุฏูุงโฆ ุจุณ ุจุฑุถู ุจูุงุด ูููุฑ/ููุธูุงุช ูููุฉ.");
  if (hasAny(message, ["ูุฏูุฉ", "ุชุบููู", "gift"])) extra.push("ูู ูุฏูุฉ: ูููููู ุณุชุงูููุง (ูุงุนู/ุฌุฑุฆ) ูุฃูุง ุฃุฑุดุญูู 2-3 ุงุฎุชูุงุฑุงุช.");

  const tips = [...(ACCESSORY_TIPS[type] || ACCESSORY_TIPS["ุนุงูุฉ"]), ...extra].slice(0, 6);

  return wrapReply({
    opener: pick(["ูุง ููุง ูุง ููุฑ ๐", "ุชูุงู ูุง ุฌูููุฉ ๐", "ุญุงุถุฑ ูุง ุญุจูู โจ"]),
    title: `ุฅูุณุณูุงุฑุงุช โ ${type}${mat ? ` (${mat})` : ""}`,
    bullets: tips,
    ask: "ุงูุฎุงูุฉ ุฅูู ุจุงูุธุจุทุ ูุจุชุชูุจุณ ูููููุง ููุง ููุงุณุจุงุชุ"
  });
}

// ===== Makeup =====
function makeupReply(message) {
  const m = message;
  let focus = "ูููุงุจ";
  if (hasAny(m, ["ูุงููุฏูุดู", "foundation"])) focus = "ูุงููุฏูุดู";
  else if (hasAny(m, ["ูููุณููุฑ", "concealer"])) focus = "ูููุณููุฑ";
  else if (hasAny(m, ["ุจูุฏุฑุฉ", "powder"])) focus = "ุจูุฏุฑุฉ";
  else if (hasAny(m, ["ุจูุงุดุฑ", "blush"])) focus = "ุจูุงุดุฑ";
  else if (hasAny(m, ["ุฑูุฌ", "lip", "ููุจ"])) focus = "ุฑูุฌ";
  else if (hasAny(m, ["ูุงุณูุงุฑุง", "mascara"])) focus = "ูุงุณูุงุฑุง";
  else if (hasAny(m, ["ุขูุดุงุฏู", "ุงูุดุงุฏู", "eyeshadow"])) focus = "ุขูุดุงุฏู";
  else if (hasAny(m, ["ุจุฑุงููุฑ", "primer"])) focus = "ุจุฑุงููุฑ";
  else if (hasAny(m, ["setting", "ุณุชูุฌ", "ุณุจุฑุงู"])) focus = "ุชุซุจูุช";

  const bulletsByFocus = {
    "ูุงููุฏูุดู": [
      "ูู ุจุดุฑุชู ุฏูููุฉ: ุงุฎุชุงุฑู Finish ูุงุช/ุณููุช ูุงุช + ุจูุฏุฑุฉ ุฎูููุฉ ุนูู ุงูู T-zone.",
      "ูู ุฌุงูุฉ: ุงุฎุชุงุฑู Dewy/ุชุฑุทูุจ ุฃุนูู + ุญุถูุฑู ุงูุจุดุฑุฉ ุจูุฑุทุจ ูููุณ.",
      "ูู ุจูุฃูุณุฏ (ูุณููุฏ): ุญุทูู ุทุจูุงุช ุฎูููุฉ ูุงุณุชูู ุฏูููุชูู ูุจู ูุง ุชุฒูุฏู.",
      "ุงุฎุชุจุฑู ุงูุฏุฑุฌุฉ ุนูู ุฎุท ุงููู ูู ุถูุก ุงูููุงุฑ."
    ],
    "ูููุณููุฑ": [
      "ุชุญุช ุงูุนูู: ุฏุฑุฌุฉ ุฃูุชุญ ุจูุต ุฏุฑุฌุฉ ูุจููุงู ูุฑููู ุฎููู.",
      "ููุญูุจูุฉ/ุงูุขุซุงุฑ: ููุณ ุฏุฑุฌุฉ ุจุดุฑุชู ูููุงู ุฃุณูู ุดููุฉ.",
      "ุชุซุจูุช ุจุณูุท ุจุจูุฏุฑุฉ (ูููุฉ ููููุฉ) ุนุดุงู ููููุฑูุด."
    ],
    "ุจูุฏุฑุฉ": [
      "ุงูุฏูููุฉ: ุจูุฏุฑุฉ ุดูุงูุฉ/ููููุด ูุงุนู ุนูู ุงูู T-zone ุจุณ.",
      "ุงูุฌุงูุฉ: ุจูุงุด ุชูุชุฑโฆ ููุณุฉ ุฎูููุฉ ูุฑูุฒู ุนูู ุงูุชุฑุทูุจ ูุจููุง.",
      "ูู ููููู: ูููู ุงูุจูุฏุฑุฉ ูุฒูุฏู ุงูุชุฑุทูุจ/ุงูุจุฑุงููุฑ ุงูููุงุณุจ."
    ],
    "ุจุฑุงููุฑ": [
      "ูุณุงู ูุงุถุญุฉ: ุจุฑุงููุฑ Blur ุนูู ุงูููุงุทู ุงููู ูููุง ูุณุงู ุจุณ.",
      "ููุนุงู: ุจุฑุงููุฑ ูุงุช ููู T-zone.",
      "ุฌูุงู: ุจุฑุงููุฑ ูุฑุทุจ ูุจู ุฃู ุญุงุฌุฉ."
    ],
    "ุจูุงุดุฑ": [
      "ููู ูููู: ุฏุฑุฌุงุช ุฑูุฒ/ุจูุชุด ุฎูููุฉ.",
      "ุณูุฑุฉ: ุฒููุฏู ุดููุฉ ุจุณ ุจุงูุชุฏุฑูุฌ ุนุดุงู ููุถู ุดูู.",
      "ูู ุจุดุฑุชู ุฏูููุฉ: ุงูุจูุงุดุฑ ุงูุจูุฏุฑ ุจูุซุจุช ุฃูุชุฑ."
    ],
    "ุฑูุฌ": [
      "ุซุจุงุช: ููุจ ูุงููุฑ + ุฑูุฌ ูุงุช + ุชุฑุจูุช ุจููุฏูู + ุทุจูุฉ ุฎูููุฉ ุชุงููุฉ.",
