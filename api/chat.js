// api/chat.js  (NO KEY NEEDED โ) โ ูููููุฉ: ุฅูุณุณูุงุฑุงุช + ูููุงุจ + ุณููู ููุฑ (ูุตุฑู ุจูุงุชู)

function send(res, status, obj) {
  res.statusCode = status;
  res.setHeader("Content-Type", "application/json; charset=utf-8");
  res.setHeader("Cache-Control", "no-store");
  res.end(JSON.stringify(obj));
}

function readBodyJSON(req) {
  return new Promise((resolve) => {
    if (req.body && typeof req.body === "object") return resolve(req.body);

    let raw = "";
    req.on("data", (c) => (raw += c));
    req.on("end", () => {
      try { resolve(raw ? JSON.parse(raw) : {}); }
      catch { resolve({}); }
    });
  });
}

// ===== โุจุฑููุจุช ุฎูููโ ุนูู ุดูู ููุงุนุฏ ุฑุฏ =====
function wrapReply({ opener, title, bullets = [], steps = [], note, ask }) {
  const out = [];
  if (opener) out.push(opener);
  if (title) out.push(`**${title}**`);
  if (bullets.length) {
    out.push("");
    for (const b of bullets) out.push(`โ ${b}`);
  }
  if (steps.length) {
    out.push("");
    out.push("**ุฎุทูุงุช ุณุฑูุนุฉ:**");
    for (let i = 0; i < steps.length; i++) out.push(`${i + 1}) ${steps[i]}`);
  }
  if (note) {
    out.push("");
    out.push(`โ๏ธ ${note}`);
  }
  if (ask) {
    out.push("");
    out.push(`ุณุคุงู ุตุบูุฑ ูุง ููุฑ: ${ask}`);
  }
  return out.join("\n");
}

function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
function hasAny(msg, arr) { return arr.some((k) => msg.indexOf(k) !== -1); }

function detectDomain(message) {
  const m = message;
  const skincareKeys = ["ุณููู", "ุจุดุฑุฉ", "ุฑูุชูู", "ุบุณูู", "ูุฑุทุจ", "ูุงูู", "spf", "ุณูุฑู", "ููุชุงููู", "ููุงุณููุงููุฏ", "ููุงููุฑูููู", "ุฑูุชูููู", "ุชูุดูุฑ", "aha", "bha", "ุณุงููุณูููู", "ุฌููููููู", "ุญุณุงุณูุฉ", "ุญูุฉ", "ุชููุฌ", "ุงุญูุฑุงุฑ"];
  const makeupKeys = ["ูููุงุจ", "makeup", "ูุงููุฏูุดู", "ูููุณููุฑ", "ุจูุฏุฑุฉ", "ุจุฑุงููุฑ", "ุจูุงุดุฑ", "ุจุฑููุฒุฑ", "ูุงููุงูุชุฑ", "ุขูุดุงุฏู", "ุงูุดุงุฏู", "ุขููุงููุฑ", "ุงููุงููุฑ", "ูุงุณูุงุฑุง", "ุฑูุฌ", "ููุจ", "ุญูุงุฌุจ", "setting", "ุณุชูุฌ", "ุณุจุฑุงู"];
  const accKeys = ["ุฎุงุชู", "ุณูุณูุฉ", "ุงูุณูุงู", "ุบูุงูุด", "ุญูู", "ุชููุฉ", "ุฏุจูุณ", "ููููู", "ุฎูุฎุงู", "ุงูุณุณูุงุฑ", "ุฅูุณุณูุงุฑ", "ุณุชุงููุณ", "ูุถุฉ", "ูุทูู"];

  if (hasAny(m, skincareKeys)) return "skincare";
  if (hasAny(m, makeupKeys)) return "makeup";
  if (hasAny(m, accKeys)) return "accessories";
  return "general";
}

function detectAccessoryType(message, hintType) {
  const m = message;
  if (m.indexOf("ุฎุงุชู") !== -1) return "ุฎุงุชู";
  if (m.indexOf("ุณูุณูุฉ") !== -1 || m.indexOf("ุณูุณูู") !== -1 || m.indexOf("ููููู") !== -1) return "ุณูุณูุฉ";
  if (m.indexOf("ุงูุณูุงู") !== -1 || m.indexOf("ุงุณูุฑุฉ") !== -1 || m.indexOf("ุฃุณูุฑุฉ") !== -1 || m.indexOf("ุณูุงุฑ") !== -1) return "ุงูุณูุงู";
  if (m.indexOf("ุบูุงูุด") !== -1 || m.indexOf("ุบููุดุฉ") !== -1 || m.indexOf("ุบููุดู") !== -1) return "ุบูุงูุด";
  if (m.indexOf("ุญูู") !== -1 || m.indexOf("ูุฑุท") !== -1) return "ุญูู";
  if (m.indexOf("ุฎูุฎุงู") !== -1) return "ุฎูุฎุงู";
  if (m.indexOf("ุชููุฉ") !== -1 || m.indexOf("ุฏุจูุณ") !== -1) return "ุชูู/ุฏุจุงุจูุณ";
  return hintType || "ุนุงูุฉ";
}

function detectSkinType(message) {
  const m = message;
  if (hasAny(m, ["ุฏูููุฉ", "ุฏูููู", "ุฒูุชูุฉ"])) return "ุฏูููุฉ";
  if (hasAny(m, ["ุฌุงูุฉ", "ุฌุงูู", "ูุงุดูุฉ", "ูุงุดูู"])) return "ุฌุงูุฉ";
  if (hasAny(m, ["ูุฎุชูุทุฉ", "ูุฎูุทุฉ", "ูููุณ"])) return "ูุฎุชูุทุฉ";
  if (hasAny(m, ["ุญุณุงุณุฉ", "ุญุณุงุณู"])) return "ุญุณุงุณุฉ";
  if (hasAny(m, ["ุนุงุฏูุฉ", "ุนุงุฏูู"])) return "ุนุงุฏูุฉ";
  return "";
}

function detectConcern(message) {
  const m = message;
  if (hasAny(m, ["ุญุจูุจ", "ุญุจุงูุฉ", "acne"])) return "ุญุจูุจ";
  if (hasAny(m, ["ุชุตุจุบุงุช", "ุจูุน", "ุงุณูุฑุงุฑ", "ููู"])) return "ุชุตุจุบุงุช";
  if (hasAny(m, ["ูุณุงู", "pore"])) return "ูุณุงู";
  if (hasAny(m, ["ุฌูุงู", "ุดุฏ", "ุชูุดูุฑ"])) return "ุฌูุงู";
  if (hasAny(m, ["ุญุณุงุณูุฉ", "ุชููุฌ", "ุงุญูุฑุงุฑ", "ุญูุฉ"])) return "ุญุณุงุณูุฉ";
  if (hasAny(m, ["ุจูุชุงู", "glow", "ุงุดุฑุงู"])) return "ุจูุชุงู";
  return "";
}

// ===== Accessories =====
const ACCESSORY_TIPS = {
  "ุฎุงุชู": [
    "ุงุจุนุฏูู ุนู ุงูููุฉ ูุงูุตุงุจูู ูุงููุญูู ุนุดุงู ุงูููู ูุงููุตูุต ููุถููุง ุญูููู.",
    "ุดูููู ููุช ุงูุญููุงู/ุบุณูู ุงูููุงุนููโฆ ุนุดุงู ูุงูุฒุญููุด ููุชูู.",
    "ุฎุฒููู ููุญุฏู ูู ููุณ ููุงุด/ุนูุจุฉ ุนุดุงู ููุฎุฑุจุด ูุน ุงููุทุน ุงูุชุงููุฉ."
  ],
  "ุณูุณูุฉ": [
    "ุจูุงุด ููู ุจููุง ุนุดุงู ูุชุชุนูุฏุด.",
    "ุงูุจุฑูุงู ูุงุฒู ููุดู ุงูุฃูู ูุจุนุฏูู ุชูุจุณููุง.",
    "ูู ุงุชุนูุฏุช: ุงูุฑุฏููุง ูุญุฑููู ุงูุนูุฏุฉ ุจูุฏูุก ุจุฏุจูุณ."
  ],
  "ุงูุณูุงู": [
    "ุดูููู ููุช ุงูุดุงูุฑ ูุงูุจุญุฑ ูุงููููุฑ.",
    "ุจูุงุด ุดุฏ ุฌุงูุฏ ุนูู ุงูุณูุณูุฉ ุงูุฑูููุฉ.",
    "ุงูุณุญูู ุจุนุฏ ุงููุจุณ ุจูุทูุฉ ูุงุดูุฉ."
  ],
  "ุบูุงูุด": [
    "ุงุจุนุฏููุง ุนู ุงูุฎุจุทุงุช ุนุดุงู ูุชุชุฌุฑุญุด.",
    "ูููุนู ุจูุทูุฉ ูุงุดูุฉ/ูููุฑููุงูุจุฑ.",
    "ูุชุชุฎุฒููุด ููู ูุจูููุฉ."
  ],
  "ุญูู": [
    "ูู ูุฏูู ุจุชุชุญุณุณ: ุงุฎุชุงุฑู ุณุชุงููุณ/ูุถุฉ ููุถูู ูุจู ุงููุจุณ.",
    "ูุชูุงููุด ุจูู ูู ุทููู/ูุฏููู.",
    "ุจูุงุด ุนุทุฑ ูุจุงุดุฑ ุนููู."
  ],
  "ุฎูุฎุงู": [
    "ุงุจุนุฏูู ุนู ุงูููุฉ ูุงููููุฑ.",
    "ุฎุฒููู ููุญุฏู ุนุดุงู ููุฎุฏุด ุฎุฏูุด.",
    "ุงูุณุญูู ูุงุดู ุจุนุฏ ุงููุจุณ."
  ],
  "ุชูู/ุฏุจุงุจูุณ": [
    "ุฎูููู ุจุนูุฏ ุนู ุงูููุฉ ุนุดุงู ุงููุนุฏู ููุณููุณุด.",
    "ุชูุถูู ุฎููู ุจูุฑุดุฉ ูุงุนูุฉ ูุงุดูุฉ.",
    "ุฎุฒูููู ูู ุนูุจุฉ ููุณููุฉ."
  ],
  "ุนุงูุฉ": [
    "ูุงุนุฏุฉ ูููููุฉ: ููุฉ + ุนุทุฑ + ูุญูู = ุนูุฑ ุงููุทุนุฉ ููุตุฑ ๐",
    "ุฎุฒููู ูู ูุทุนุฉ ููุญุฏูุง ูุงูุณุญููุง ูุงุดู ุจุนุฏ ุงููุจุณ.",
    "ูู ุงูููู ุจูุบูู ุจุณุฑุนุฉ: ุบุงูุจูุง ุนุฑู/ุนุทุฑโฆ ุฎููู ุจุนูุฏ."
  ]
};

function accessoryReply(message, hintType) {
  const type = detectAccessoryType(message, hintType);
  const tips = (ACCESSORY_TIPS[type] || ACCESSORY_TIPS["ุนุงูุฉ"]).slice(0, 5);

  return wrapReply({
    opener: pick(["ูุง ููุง ูุง ููุฑ ๐", "ุชูุงู ูุง ุฌูููุฉ ๐", "ุญุงุถุฑ ูุง ุญุจูู โจ"]),
    title: `ุฅูุณุณูุงุฑุงุช โ ${type}`,
    bullets: tips,
    ask: "ุงููุทุนุฉ ุฎุงูุชูุง ุฅููุ (ุณุชุงููุณ/ูุทูู/ูุถุฉ) ูุจุชุชูุจุณ ูููููุง ููุง ููุงุณุจุงุชุ"
  });
}

// ===== Makeup =====
function makeupReply(message) {
  const m = message;
  let focus = "ูููุงุจ";
  if (hasAny(m, ["ูุงููุฏูุดู","foundation"])) focus = "ูุงููุฏูุดู";
  else if (hasAny(m, ["ูููุณููุฑ","concealer"])) focus = "ูููุณููุฑ";
  else if (hasAny(m, ["ุจูุฏุฑุฉ","powder"])) focus = "ุจูุฏุฑุฉ";
  else if (hasAny(m, ["ุจูุงุดุฑ","blush"])) focus = "ุจูุงุดุฑ";
  else if (hasAny(m, ["ุฑูุฌ","ููุจ","lip"])) focus = "ุฑูุฌ";
  else if (hasAny(m, ["ูุงุณูุงุฑุง","m]()
