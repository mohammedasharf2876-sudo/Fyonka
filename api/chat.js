// api/chat.js  (NO KEY NEEDED âœ…)
async function readBodyJSON(req) {
  if (req.body && typeof req.body === "object") return req.body;
  let raw = "";
  for await (const chunk of req) raw += chunk;
  if (!raw) return {};
  try { return JSON.parse(raw); } catch { return {}; }
}

function send(res, status, obj) {
  res.statusCode = status;
  res.setHeader("Content-Type", "application/json; charset=utf-8");
  res.setHeader("Cache-Control", "no-store");
  res.end(JSON.stringify(obj));
}

const DB = {
  "Ø®Ø§ØªÙ…": [
    "ðŸ’ Ø§Ù„Ø®Ø§ØªÙ… ÙŠØ¬Ù†Ù† Ø¹Ù„ÙŠÙƒÙŠ! Ø§Ø¨Ø¹Ø¯ÙŠÙ‡ Ø¹Ù† Ø§Ù„Ù…ÙŠØ© ÙˆØ§Ù„ØµØ§Ø¨ÙˆÙ† ÙˆØ§Ù„ÙƒØ­ÙˆÙ„. Ù„Ùˆ Ù‡ØªØºØ³Ù„ÙŠ Ø¥ÙŠØ¯Ùƒ Ø´ÙŠÙ„ÙŠÙ‡ Ø¹Ø´Ø§Ù† Ù…ÙŠØªØ²Ø­Ù„Ù‚Ø´.",
    "âœ¨ Ù„Ùˆ ÙÙŠÙ‡ ÙØµÙˆØµ: Ù†Ø¸Ø§ÙØ© Ø¨Ù‚Ø·Ù†Ø© Ù†Ø§Ø´ÙØ© Ø£Ùˆ ÙØ±Ø´Ø© Ù†Ø§Ø¹Ù…Ø© Ø¬Ø¯Ù‹Ø§ (Ù…Ù† ØºÙŠØ± Ù…ÙŠØ©). ÙˆØ®Ø²Ù†ÙŠÙ‡ Ù„ÙˆØ­Ø¯Ù‡ Ø¹Ø´Ø§Ù† Ù…ÙŠØªØ®Ø±Ø¨Ø´."
  ],
  "Ø³Ù„Ø³Ù„Ø©": [
    "ðŸ“¿ Ø§Ù„Ø³Ù„Ø§Ø³Ù„ Ø§Ù„Ø±Ù‚ÙŠÙ‚Ø© Ø¨ØªØ­Ø¨ Ø§Ù„Ø¯Ù„Ø¹: Ø¨Ù„Ø§Ø´ Ù†ÙˆÙ… Ø¨ÙŠÙ‡Ø§ Ø¹Ø´Ø§Ù† Ù…ØªØªØ¹Ù‚Ø¯Ø´ØŒ ÙˆØ¨Ù„Ø§Ø´ Ø¨Ø±ÙØ§Ù† Ù…Ø¨Ø§Ø´Ø±.",
    "ðŸ’— Ù„Ùˆ Ø§ØªØ¹Ù‚Ø¯Øª: Ø§ÙØ±Ø¯ÙŠÙ‡Ø§ Ø¹Ù„Ù‰ Ø³Ø·Ø­ Ù†Ø§Ø¹Ù… ÙˆØ­Ø±ÙƒÙŠ Ø§Ù„Ø¹Ù‚Ø¯Ø© Ø¨Ø¥Ø¨Ø±Ø© Ø±ÙÙŠØ¹Ø©/Ø¯Ø¨ÙˆØ³ Ø¨Ù‡Ø¯ÙˆØ¡."
  ],
  "Ø³Ø§Ø¹Ø©": [
    "âŒš Ø­ØªÙ‰ Ù„Ùˆ Ø¶Ø¯ Ø§Ù„Ù…ÙŠØ©ØŒ Ø§Ù„ØµØ§Ø¨ÙˆÙ† ÙˆØ§Ù„ÙƒÙŠÙ…Ø§ÙˆÙŠØ§Øª Ø¨ÙŠØ¨ÙˆØ¸ÙˆØ§ Ø§Ù„Ù„Ù…Ø¹Ø©/Ø§Ù„Ø¬Ù„Ø¯. Ø§Ù…Ø³Ø­ÙŠÙ‡Ø§ Ø¨Ù‚Ø·Ù†Ø© Ù†Ø§Ø´ÙØ©.",
    "ðŸ‘œ Ø®Ø¯ÙŠ Ø¨Ø§Ù„Ùƒ Ù…Ù† Ø§Ù„Ø¹Ø·ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ± (Ø§Ù„Ø¬Ù„Ø¯ Ø®ØµÙˆØµÙ‹Ø§) Ù„Ø£Ù†Ù‡Ø§ Ø¨ØªØºÙŠÙ‘Ø± Ø§Ù„Ù„ÙˆÙ†."
  ],
  "ØºÙˆØ§ÙŠØ´": [
    "ðŸ’« Ø§Ù„ØºÙˆØ§ÙŠØ´ Ù…Ø­ØªØ§Ø¬Ø© Ø­Ø±Øµ: Ø§Ø¨Ø¹Ø¯ÙŠÙ‡Ø§ Ø¹Ù† Ø§Ù„Ø®Ø¨Ø·Ø§Øª ÙˆÙ„Ù…Ø¹ÙŠÙ‡Ø§ Ø¨Ù‚Ø·Ù†Ø© Ù†Ø§Ø´ÙØ©.",
    "âœ¨ Ù…ØªØªØ­Ø·ÙŠØ´ Ù…Ø¹Ø§Ù‡Ø§ Ù‚Ø·Ø¹ Ø­Ø§Ø¯Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙƒÙŠØ³ Ø¹Ø´Ø§Ù† Ù…ØªØªØ®Ø±Ø¨Ø´."
  ],
  "Ø¹Ø§Ù…Ø©": [
    "ðŸŽ€ Ø£ÙŠ Ø¥ÙƒØ³Ø³ÙˆØ§Ø±: Ø§Ø¨Ø¹Ø¯ÙŠÙ‡ Ø¹Ù† Ø§Ù„Ù…ÙŠØ© ÙˆØ§Ù„ÙƒØ­ÙˆÙ„ ÙˆØ§Ù„Ø¨Ø±ÙØ§Ù† Ø§Ù„Ù…Ø¨Ø§Ø´Ø±â€¦ ÙˆØ®Ø²Ù†ÙŠÙ‡ ÙÙŠ ÙƒÙŠØ³/Ø¹Ù„Ø¨Ø© Ù„ÙˆØ­Ø¯Ù‡.",
    "ðŸ’– Ù„Ùˆ Ø§Ù„Ù‚Ø·Ø¹Ø© Ù„ÙˆÙ†Ù‡Ø§ Ø¨Ø¯Ø£ ÙŠØ±ÙˆØ­: ØºØ§Ù„Ø¨Ù‹Ø§ Ø¨Ø³Ø¨Ø¨ Ø¹Ø±Ù‚/Ø¹Ø·Ø±/Ù…ÙŠØ©â€¦ Ø®Ù„ÙŠÙ‡Ø§ Ù†Ø§Ø´ÙØ© Ø¯Ø§ÙŠÙ…Ù‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ù„Ø¨Ø³."
  ]
};

const QUICK = [
  { k: ["Ø³Ø¹Ø±","Ø¨ÙƒØ§Ù…","Ø§Ù„Ø«Ù…Ù†","ÙƒØ§Ù…"], r: "ðŸ’— Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¨ØªØ®ØªÙ„Ù Ø­Ø³Ø¨ Ø§Ù„Ø®Ø§Ù…Ø© ÙˆØ§Ù„Ù…ÙˆØ¯ÙŠÙ„â€¦ Ù‚ÙˆÙ„ÙŠÙ„ÙŠ Ø§Ù„Ù‚Ø·Ø¹Ø©/ØµÙˆØ±Ø© Ø£Ùˆ ÙˆØµÙÙŠÙ‡Ø§ ÙˆØ£Ù†Ø§ Ø£Ù‚ÙˆÙ„Ùƒ Ø£Ù†Ø³Ø¨ Ø§Ø®ØªÙŠØ§Ø±." },
  { k: ["Ù…Ù‚Ø§Ø³","Ù‚ÙŠØ§Ø³","ÙˆØ§Ø³Ø¹","Ø¶ÙŠÙ‚"], r: "ðŸ“ Ù‚ÙˆÙ„ÙŠÙ„ÙŠ Ù…Ù‚Ø§Ø³Ùƒ/Ù…Ø­ÙŠØ· Ø§Ù„Ø¥ØµØ¨Ø¹ Ø£Ùˆ Ø§Ù„Ù…Ø¹ØµÙ… Ø¨Ø§Ù„Ø³Ù†ØªÙŠâ€¦ ÙˆØ£Ù†Ø§ Ø£Ø³Ø§Ø¹Ø¯Ùƒ ØªØ®ØªØ§Ø±ÙŠ Ø§Ù„Ù…Ù‚Ø§Ø³ Ø§Ù„ØµØ­." },
  { k: ["Ø´Ø­Ù†","ØªÙˆØµÙŠÙ„","Ø¯Ù„ÙŠÙØ±ÙŠ"], r: "ðŸšš Ø§Ù„ØªÙˆØµÙŠÙ„ Ù…ØªØ§Ø­â€”Ù‚ÙˆÙ„ÙŠÙ„ÙŠ Ù…Ø­Ø§ÙØ¸ØªÙƒ/Ù…Ù†Ø·Ù‚ØªÙƒ ÙˆÙ‡Ù‚ÙˆÙ„Ùƒ Ø§Ù„Ù…Ø¯Ø© ÙˆØ§Ù„ØªÙƒÙ„ÙØ©." },
  { k: ["Ù…Ø§Øª","ØªØºÙŠØ±","Ø§Ø³ÙˆØ¯","ØµØ¯Ø£","ØªØ³ÙˆØ¯"], r: "ðŸ–¤ Ø¯Ù‡ Ø¨ÙŠØ­ØµÙ„ Ù…Ù† Ù…ÙŠØ©/Ø¹Ø±Ù‚/Ø¹Ø·Ø±. Ø§Ù…Ø³Ø­ÙŠÙ‡Ø§ Ù†Ø§Ø´Ù ÙÙˆØ±Ù‹Ø§ ÙˆØ®Ø²Ù†ÙŠÙ‡Ø§ Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ø§Ù„Ø±Ø·ÙˆØ¨Ø©. Ù‚ÙˆÙ„ÙŠÙ„ÙŠ Ù†ÙˆØ¹Ù‡Ø§ (Ø®Ø§ØªÙ…/Ø³Ù„Ø³Ù„Ø©/Ø³Ø§Ø¹Ø©/ØºÙˆØ§ÙŠØ´) Ø¹Ø´Ø§Ù† Ø£Ø¯ÙŠÙƒÙŠ Ø·Ø±ÙŠÙ‚Ø© Ø£Ù†Ø³Ø¨." }
];

function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

function detectType(fallbackType, message) {
  const m = message;
  if (m.includes("Ø®Ø§ØªÙ…")) return "Ø®Ø§ØªÙ…";
  if (m.includes("Ø³Ù„Ø³Ù„Ø©") || m.includes("chain")) return "Ø³Ù„Ø³Ù„Ø©";
  if (m.includes("Ø³Ø§Ø¹Ø©") || m.includes("watch")) return "Ø³Ø§Ø¹Ø©";
  if (m.includes("ØºÙˆÙŠØ´Ø©") || m.includes("ØºÙˆØ§ÙŠØ´") || m.includes("Ø§Ø³ÙˆØ±Ø©") || m.includes("Ø£Ø³ÙˆØ±Ø©")) return "ØºÙˆØ§ÙŠØ´";
  return fallbackType;
}

export default async function handler(req, res) {
  try {
    if (req.method === "GET") {
      return send(res, 200, { ok: true, mode: "NO-KEY-RULES", route: "/api/chat" });
    }
    if (req.method !== "POST") return send(res, 405, { error: "Method not allowed" });

    const body = await readBodyJSON(req);
    const typeIn = String(body.type || "Ø¹Ø§Ù…Ø©");
    const message = String(body.message || "").trim();

    if (!message) return send(res, 400, { reply: "Ù‚ÙˆÙ„ÙŠ Ø³Ø¤Ø§Ù„Ùƒ ÙŠØ§ Ù‚Ù…Ø± ðŸŽ€" });

    // Ø±Ø¯ÙˆØ¯ Ø³Ø±ÙŠØ¹Ø© Ø­Ø³Ø¨ ÙƒÙ„Ù…Ø§Øª
    for (const item of QUICK) {
      if (item.k.some(w => message.includes(w))) {
        return send(res, 200, { reply: item.r });
      }
    }

    const t = detectType(typeIn, message);
    const tips = DB[t] || DB["Ø¹Ø§Ù…Ø©"];
    const reply = `ðŸŽ€ ØªÙ…Ø§Ù… ÙŠØ§ Ù‚Ù…Ø±â€¦ Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„Ù€ <b>${t}</b>:\n\n${pick(tips)}\n\nÙ„Ùˆ ØªØ­Ø¨ÙŠ Ù‚ÙˆÙ„ÙŠÙ„ÙŠ Ø¨ØªØªÙ„Ø¨Ø³ Ø¥Ù…ØªÙ‰ ÙˆØ¨ØªØªØ¹Ø±Ø¶ Ù„Ù…ÙŠØ©/Ø¹Ø·Ø± Ù‚Ø¯ Ø¥ÙŠÙ‡ØŸ`;

    return send(res, 200, { reply });
  } catch (e) {
    return send(res, 500, { reply: "Ù…Ø¹Ù„Ø´ ÙŠØ§ Ù‚Ù…Ø± Ø­ØµÙ„ Ù…Ø´ÙƒÙ„Ø©â€¦ Ø¬Ø±Ø¨ÙŠ ØªØ§Ù†ÙŠ ðŸŽ€" });
  }
}
