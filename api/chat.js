export default async function handler(req, res) {
  // response helper
  function send(status, obj) {
    res.statusCode = status;
    res.setHeader("Content-Type", "application/json; charset=utf-8");
    res.setHeader("Cache-Control", "no-store");
    res.end(JSON.stringify(obj));
  }

  // quick test endpoint
  if (req.method === "GET") {
    return send(200, { ok: true, route: "/api/chat", mode: "NO-KEY-FYONKA" });
  }

  if (req.method !== "POST") {
    return send(405, { reply: "Method not allowed" });
  }

  // parse body safely
  const body = await new Promise((resolve) => {
    try {
      if (req.body && typeof req.body === "object") return resolve(req.body);

      let raw = "";
      req.on("data", (c) => (raw += c));
      req.on("end", () => {
        if (!raw) return resolve({});
        try { resolve(JSON.parse(raw)); } catch { resolve({}); }
      });
    } catch {
      resolve({});
    }
  });

  const message = String(body.message || "").trim();
  const hintType = String(body.type || "ุนุงูุฉ");

  if (!message) return send(200, { reply: "ูููู ุณุคุงูู ูุง ููุฑ ๐" });

  // ====== โุจุฑููุจุช ุฎูููโ (ููุงุนุฏ ุฑุฏ) ======
  const m = message;

  const skincareKeys = ["ุจุดุฑุฉ","ุณููู","ุฑูุชูู","ุบุณูู","ูุฑุทุจ","ูุงูู","spf","ุณูุฑู","ููุชุงููู","ููุงุณููุงููุฏ","ููุงููุฑูููู","ุฑูุชูููู","ุชูุดูุฑ","aha","bha","ุณุงููุณูููู","ุฌููููููู","ุญุณุงุณูุฉ","ุชููุฌ","ุงุญูุฑุงุฑ","ุญูุฉ","ุญุจูุจ","ุชุตุจุบุงุช","ูุณุงู"];
  const makeupKeys   = ["ูููุงุจ","makeup","ูุงููุฏูุดู","ูููุณููุฑ","ุจูุฏุฑุฉ","ุจุฑุงููุฑ","ุจูุงุดุฑ","ุจุฑููุฒุฑ","ูุงููุงูุชุฑ","ุงูุดุงุฏู","ุขูุดุงุฏู","ุงููุงููุฑ","ุขููุงููุฑ","ูุงุณูุงุฑุง","ุฑูุฌ","ููุจ","ุญูุงุฌุจ","ุณุชูุฌ","setting","ุณุจุฑุงู"];
  const accKeys      = ["ุฎุงุชู","ุณูุณูุฉ","ุณูุณูู","ุงูุณูุงู","ุงุณูุฑุฉ","ุฃุณูุฑุฉ","ุณูุงุฑ","ุบูุงูุด","ุบููุดุฉ","ุญูู","ูุฑุท","ุฎูุฎุงู","ุชููุฉ","ุฏุจูุณ","ููููู","ุงูุณุณูุงุฑ","ุฅูุณุณูุงุฑ","ุณุชุงููุณ","ูุถุฉ","ูุทูู","ูุทููู"];

  function hasAny(keys) {
    for (let i = 0; i < keys.length; i++) if (m.indexOf(keys[i]) !== -1) return true;
    return false;
  }

  function opener() {
    const arr = ["ูุง ููุง ูุง ููุฑ ๐", "ุชูุงู ูุง ุฌูููุฉ ๐", "ุญุงุถุฑ ูุง ุญุจูู โจ"];
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function wrap(title, bullets, ask, note) {
    let out = [];
    out.push(opener());
    out.push("**" + title + "**");
    out.push("");
    for (let i = 0; i < bullets.length; i++) out.push("โ " + bullets[i]);
    if (note) {
      out.push("");
      out.push("โ๏ธ " + note);
    }
    if (ask) {
      out.push("");
      out.push("ุณุคุงู ุตุบูุฑ ูุง ููุฑ: " + ask);
    }
    return out.join("\n");
  }

  // -------- Accessories
  function accessoryType() {
    if (m.indexOf("ุฎุงุชู") !== -1) return "ุฎุงุชู";
    if (m.indexOf("ุณูุณูุฉ") !== -1 || m.indexOf("ุณูุณูู") !== -1 || m.indexOf("ููููู") !== -1) return "ุณูุณูุฉ";
    if (m.indexOf("ุงูุณูุงู") !== -1 || m.indexOf("ุงุณูุฑุฉ") !== -1 || m.indexOf("ุฃุณูุฑุฉ") !== -1 || m.indexOf("ุณูุงุฑ") !== -1) return "ุงูุณูุงู";
    if (m.indexOf("ุบูุงูุด") !== -1 || m.indexOf("ุบููุดุฉ") !== -1 || m.indexOf("ุบููุดู") !== -1) return "ุบูุงูุด";
    if (m.indexOf("ุญูู") !== -1 || m.indexOf("ูุฑุท") !== -1) return "ุญูู";
    if (m.indexOf("ุฎูุฎุงู") !== -1) return "ุฎูุฎุงู";
    if (m.indexOf("ุชููุฉ") !== -1 || m.indexOf("ุฏุจูุณ") !== -1) return "ุชูู/ุฏุจุงุจูุณ";
    return hintType || "ุนุงูุฉ";
  }

  const ACC = {
    "ุฎุงุชู": ["ุงุจุนุฏูู ุนู ุงูููุฉ ูุงูุตุงุจูู ูุงููุญูู.", "ุดูููู ููุช ุงูุญูุงู/ุบุณูู ุงูููุงุนูู.", "ุฎุฒููู ููุญุฏู ูู ุนูุจุฉ/ููุณ ููุงุด."],
    "ุณูุณูุฉ": ["ุจูุงุด ููู ุจููุง ุนุดุงู ูุชุชุนูุฏุด.", "ุงูุจุฑูุงู ููุดู ุงูุฃูู ูุจุนุฏูู ุชูุจุณููุง.", "ูู ุงุชุนูุฏุช: ุงูุฑุฏููุง ูุญุฑููู ุงูุนูุฏุฉ ุจุฏุจูุณ."],
    "ุงูุณูุงู": ["ุดูููู ููุช ุงูุดุงูุฑ ูุงูุจุญุฑ ูุงููููุฑ.", "ุจูุงุด ุดุฏ ุฌุงูุฏ ุนูู ุงูุฑููู.", "ุงูุณุญูู ุจุนุฏ ุงููุจุณ ุจูุทูุฉ ูุงุดูุฉ."],
    "ุบูุงูุด": ["ุงุจุนุฏููุง ุนู ุงูุฎุจุทุงุช.", "ูููุนู ุจูุทูุฉ ูุงุดูุฉ.", "ูุชุชุฎุฒููุด ููู ูุจูููุฉ."],
    "ุญูู": ["ูู ุจุชุญุณุณู: ุณุชุงููุณ/ูุถุฉ ุฃุญุณู.", "ูุชูุงููุด ุจูู ูู ุทููู.", "ุจูุงุด ุนุทุฑ ูุจุงุดุฑ ุนููู."],
    "ุฎูุฎุงู": ["ุงุจุนุฏูู ุนู ุงูููุฉ ูุงููููุฑ.", "ุฎุฒููู ููุญุฏู.", "ุงูุณุญูู ูุงุดู ุจุนุฏ ุงููุจุณ."],
    "ุชูู/ุฏุจุงุจูุณ": ["ุฎูููู ุจุนูุฏ ุนู ุงูููุฉ.", "ุชูุถูู ูุงุดู ุจูุฑุดุฉ ูุงุนูุฉ.", "ุฎุฒูููู ูู ุนูุจุฉ ููุณููุฉ."],
    "ุนุงูุฉ": ["ููุฉ + ุนุทุฑ + ูุญูู = ุนูุฑ ุงููุทุนุฉ ููุตุฑ ๐", "ุฎุฒููู ูู ูุทุนุฉ ููุญุฏูุง.", "ุงูุณุญููุง ูุงุดู ุจุนุฏ ุงููุจุณ."]
  };

  // -------- Makeup
  function makeupFocus() {
    if (m.indexOf("ูุงููุฏูุดู") !== -1) return "ูุงููุฏูุดู";
    if (m.indexOf("ูููุณููุฑ") !== -1) return "ูููุณููุฑ";
    if (m.indexOf("ุจูุฏุฑุฉ") !== -1) return "ุจูุฏุฑุฉ";
    if (m.indexOf("ุจุฑุงููุฑ") !== -1) return "ุจุฑุงููุฑ";
    if (m.indexOf("ุจูุงุดุฑ") !== -1) return "ุจูุงุดุฑ";
    if (m.indexOf("ุฑูุฌ") !== -1 || m.indexOf("ููุจ") !== -1) return "ุฑูุฌ";
    if (m.indexOf("ูุงุณูุงุฑุง") !== -1) return "ูุงุณูุงุฑุง";
    if (m.indexOf("ุงููุงููุฑ") !== -1 || m.indexOf("ุขููุงููุฑ") !== -1) return "ุขููุงููุฑ";
    if (m.indexOf("ุงูุดุงุฏู") !== -1 || m.indexOf("ุขูุดุงุฏู") !== -1) return "ุขูุดุงุฏู";
    if (m.indexOf("ุณุชูุฌ") !== -1 || m.indexOf("setting") !== -1 || m.indexOf("ุณุจุฑุงู") !== -1) return "ุชุซุจูุช";
    return "ูููุงุจ";
  }

  const MK = {
    "ูุงููุฏูุดู": ["ุฏูููุฉ: ูุงุช/ุณููุช ูุงุช + ุจูุฏุฑุฉ ุนูู ุงููT-zone.", "ุฌุงูุฉ: ุชุฑุทูุจ ูููุณ + ูุงููุฏูุดู ูุฑุทุจ.", "ูู ุจูุฃูุณุฏ: ุทุจูุงุช ุฎูููุฉ ูุงุณุชูู ูุจู ูุง ุชุฒูุฏู.", "ุงุฎุชุจุฑู ุงูุฏุฑุฌุฉ ุนูู ุฎุท ุงููู ูู ุถูุก ุงูููุงุฑ."],
    "ูููุณููุฑ": ["ุชุญุช ุงูุนูู: ุฃูุชุญ ุจูุต ุฏุฑุฌุฉ ูููุงู ุฎููู.", "ููุญูุจูุฉ: ููุณ ุฏุฑุฌุฉ ุจุดุฑุชู ูููุงู ุฃุณูู.", "ุชุซุจูุช ุจุณูุท ุจุจูุฏุฑุฉ ุนุดุงู ููููุฑูุด."],
    "ุจูุฏุฑุฉ": ["ุงูุฏูููุฉ: ุดูุงูุฉ ุนูู ุงููT-zone ุจุณ.", "ุงูุฌุงูุฉ: ููุณุฉ ุฎูููุฉ ุฌุฏูุง.", "ูู ููููู: ูููู ุงููููุฉ ูุฒูุฏู ุงูุชุฑุทูุจ."],
    "ุจุฑุงููุฑ": ["ูุณุงู: blur ุนูู ุงูููุงุทู ุฏู ุจุณ.", "ููุนุงู: ูุงุช ูููT-zone.", "ุฌูุงู: ุจุฑุงููุฑ ูุฑุทุจ."],
    "ุจูุงุดุฑ": ["ูููู: ุฑูุฒ/ุจูุชุด ุฎููู.", "ุณูุฑุฉ: ุฒูุฏู ุจุงูุชุฏุฑูุฌ.", "ุฏูููุฉ: ุงูุจูุฏุฑ ุจูุซุจุช ุฃูุชุฑ."],
    "ุฑูุฌ": ["ุซุจุงุช: ูุงููุฑ + ุฑูุฌ ูุงุช + ุทุจูุฉ ุฎูููุฉ ุชุงููุฉ.", "ุฑุงุญุฉ: ูุฑููู ูุน ุชุฑุทูุจ ูุจููุง.", "ุงุฎุชุงุฑู ุงูุฏุฑุฌุฉ ุญุณุจ ุงูุงูุฏุฑุชูู."],
    "ูุงุณูุงุฑุง": ["ูู ุจุชุณููุญ: Waterproof.", "ูุชูุชููุด: ุงูุณุญู ุงูุฒูุงุฏุฉ ูู ุงููุฑุดุฉ.", "ููุฑูุฑ ูุจููุง ููุฑู."],
    "ุขููุงููุฑ": ["ูููู: ุฎุท ุฑููุน ูุฑูุจ ูู ุงูุฑููุด.", "ุณูุฑุฉ: wing ุฎููู.", "ูู ุจูุณููุญ: ููุงูู ููููุฉ."],
    "ุขูุดุงุฏู": ["ููุงุฑ: ุจูู/ุจูุฌ + ููุนุฉ ุจุณูุทุฉ.", "ููู: ุณูููู ุฎููู.", "ุจุฑุงููุฑ ุนูู ูููุน ุงูุชุฌููุน."],
    "ุชุซุจูุช": ["ุฏูููุฉ: ุณุจุฑุงู ูุงุช.", "ุฌุงูุฉ: ุณุจุฑุงู ูุฑุทุจ.", "ุฑุดูุงุช ุฎูููุฉ ูุด ูุชูุฑ ูุฑุฉ ูุงุญุฏุฉ."],
    "ูููุงุจ": ["ูููููู ุงูููุงุณุจุฉ (ุตุจุงุญ/ุณูุฑุฉ) ูุฃูุง ุฃุธุจุทูู ููู.", "ูู ูู ูุดููุฉ (ูููู/ููุนุงู/ุฃูุณุฏุฉ) ูููููู ุจุชุญุตู ููู."]
  };

  // -------- Skincare
  function skinType() {
    if (m.indexOf("ุฏูููุฉ") !== -1 || m.indexOf("ุฏูููู") !== -1) return "ุฏูููุฉ";
    if (m.indexOf("ุฌุงูุฉ") !== -1 || m.indexOf("ุฌุงูู") !== -1 || m.indexOf("ูุงุดูุฉ") !== -1) return "ุฌุงูุฉ";
    if (m.indexOf("ูุฎุชูุทุฉ") !== -1 || m.indexOf("ูุฎูุทุฉ") !== -1) return "ูุฎุชูุทุฉ";
    if (m.indexOf("ุญุณุงุณุฉ") !== -1 || m.indexOf("ุญุณุงุณู") !== -1) return "ุญุณุงุณุฉ";
    return "";
  }
  function concern() {
    if (m.indexOf("ุญุจูุจ") !== -1) return "ุญุจูุจ";
    if (m.indexOf("ุชุตุจุบุงุช") !== -1 || m.indexOf("ุจูุน") !== -1) return "ุชุตุจุบุงุช";
    if (m.indexOf("ูุณุงู") !== -1) return "ูุณุงู";
    if (m.indexOf("ุฌูุงู") !== -1) return "ุฌูุงู";
    if (m.indexOf("ุญุณุงุณูุฉ") !== -1 || m.indexOf("ุชููุฌ") !== -1) return "ุญุณุงุณูุฉ";
    return "";
  }

  // ====== routing ======
  try {
    if (hasAny(accKeys)) {
      const t = accessoryType();
      const tips = (ACC[t] || ACC["ุนุงูุฉ"]);
      return send(200, {
        reply: wrap("ุฅูุณุณูุงุฑุงุช โ " + t, tips, "ุงูุฎุงูุฉ ุฅููุ (ุณุชุงููุณ/ูุทูู/ูุถุฉ) ูุจุชุชูุจุณ ูููููุง ููุง ููุงุณุจุงุชุ", "")
      });
    }

    if (hasAny(makeupKeys)) {
      const f = makeupFocus();
      return send(200, {
        reply: wrap("ูููุงุจ โ " + f, MK[f] || MK["ูููุงุจ"], "ููุน ุจุดุฑุชู ุฅููุ ูููู ูููู ููุง ุณูุฑุฉุ", "")
      });
    }

    if (hasAny(skincareKeys)) {
      const st = skinType();
      const co = concern();

      let bullets = [];
      bullets.push(st ? ("ุฑูุชูู ุจุณูุท ููุงุณุจ ูู **" + st + "**.") : "ูููุดู ุนูู ุฑูุชูู ุจุณูุท ูุจุนุฏูู ูุฒููุฏ ุญุณุจ ุงุญุชูุงุฌู.");
      if (co === "ุญุจูุจ") bullets.push("ููุญุจูุจ: ุณุงููุณูููู ุฎููู + ูุฑุทุจ + ูุชูุชุฑููุด ููุชุฌุงุช.");
      if (co === "ุชุตุจุบุงุช") bullets.push("ููุชุตุจุบุงุช: ููุชุงููู C ุตุจุงุญูุง + SPF ุซุงุจุช.");
      if (co === "ูุณุงู") bullets.push("ูููุณุงู: ููุงุณููุงููุฏ + ุชูุดูุฑ ุฎููู ุฃุณุจูุนููุง.");
      if (co === "ุฌูุงู") bullets.push("ููุฌูุงู: ููุงููุฑูููู ุนูู ุจุดุฑุฉ ูุจูููุฉ + ูุฑุทุจ ุชููู ุดููุฉ.");
      if (co === "ุญุณุงุณูุฉ") bullets.push("ููุชููุฌ: ูููู ุงูููุดุฑุงุช ูุคูุชูุง ูุฑูุฒู ุนูู ูุฑุทุจ ูุทูู.");

      const note = "ูู ุชููุฌ ุดุฏูุฏ/ูุณุชูุฑ: ุงูุฃูุถู ุฏูุชูุฑ ุฌูุฏูุฉ + Patch test ูุจู ุฃู ููุชุฌ ุฌุฏูุฏ.";
      const extraSteps = "\n\n**ุฎุทูุงุช ุณุฑูุนุฉ:**\n1) ุตุจุงุญูุง: ุบุณูู โ ุณูุฑู โ ูุฑุทุจ โ SPF\n2) ููููุง: ุบุณูู โ ุนูุงุฌ/ุณูุฑู โ ูุฑุทุจ";

      return send(200, {
        reply: wrap("ุณููู ููุฑ" + (st ? (" โ " + st) : "") + (co ? (" (" + co + ")") : ""),
          bullets,
          "ููุน ุจุดุฑุชู ุฅูู ูุฃูุชุฑ ูุดููุฉ ูุถุงููุงููุ",
          note
        ) + extraSteps
      });
    }

    // general
    return send(200, {
      reply: wrap("ุฃูุง ุฃุณุงุนุฏู ูู ุฅููุ",
        ["ุฅูุณุณูุงุฑุงุช: ุงุฎุชูุงุฑ + ููุงุณุงุช + ุนูุงูุฉ", "ูููุงุจ: ุฏุฑุฌุงุช + ูููุงุช + ุฎุทูุงุช", "ุณููู ููุฑ: ุฑูุชูู + ุฏูุฌ ุตุญ"],
        "ุฅูุณุณูุงุฑ ููุง ูููุงุจ ููุง ุณููู ููุฑุ",
        ""
      )
    });

  } catch (err) {
    // even routing errors return safe response
    return send(200, { reply: "ุญุตู ูุฎุจุทุฉ ุจุณูุทุฉ ูุง ููุฑ ๐ ูููู ุณุคุงูู ุชุงูู." });
  }
}
